<!doctype html>
<html lang="fr" class="h-full bg-slate-100">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>On va où ? | L'Aventure Aléatoire</title>

        <!-- Leaflet (Map) -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>

        <!-- Tailwind CSS (Design) -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Feather Icons (Icons) -->
        <script src="https://unpkg.com/feather-icons"></script>

        <!-- Google Fonts for better typography -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap"
            rel="stylesheet"
        />

        <style>
            /* Some custom CSS for the slider and font */
            body {
                font-family: "Inter", sans-serif;
            }

            /* Radius slider customization */
            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 24px;
                height: 24px;
                background: #4f46e5; /* Indigo-600 de Tailwind */
                cursor: pointer;
                border-radius: 50%;
                margin-top: -8px; /* Center the thumb on the bar */
            }

            input[type="range"]::-moz-range-thumb {
                width: 24px;
                height: 24px;
                background: #4f46e5;
                cursor: pointer;
                border-radius: 50%;
            }

            /* Animation for the loading icon */
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }
            .animate-spin-slow {
                animation: spin 1.5s linear infinite;
            }
        </style>
    </head>
    <body class="h-full antialiased">
        <div class="grid md:grid-cols-2 min-h-screen">
            <!-- Control Panel (Left) -->
            <div
                class="flex flex-col bg-white p-6 sm:p-10 shadow-2xl md:shadow-none z-10"
            >
                <header class="mb-10">
                    <h1
                        class="text-4xl sm:text-5xl font-extrabold text-slate-800 tracking-tight"
                    >
                        On va où ?
                    </h1>
                    <p class="mt-2 text-slate-500">
                        The concept of
                        <span class="font-semibold text-slate-600">Djilsi</span
                        >, for you and your friends. Ready for adventure?
                    </p>
                </header>

                <main class="flex flex-col space-y-8 flex-grow">
                    <!-- Step 1: Location -->
                    <div class="step">
                        <div class="flex items-center mb-3">
                            <span
                                class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-600 text-white font-bold text-lg mr-4"
                                >1</span
                            >
                            <h2 class="text-2xl font-bold text-slate-700">
                                Your position
                            </h2>
                        </div>
                        <div class="ml-12 space-y-4">
                            <p class="text-slate-500">
                                Use geolocation, search for your address, or
                                click directly on the map to set your starting
                                point.
                            </p>

                            <!-- Option 1: Geolocation -->
                            <button
                                id="locateBtn"
                                class="w-full flex items-center justify-center gap-3 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            >
                                <i data-feather="map-pin" class="w-5 h-5"></i>
                                <span>Locate me</span>
                            </button>

                            <!-- Separator -->
                            <div
                                class="flex items-center text-slate-400 text-sm"
                            >
                                <div
                                    class="flex-grow border-t border-slate-200"
                                ></div>
                                <span class="flex-shrink mx-4 font-semibold"
                                    >OR</span
                                >
                                <div
                                    class="flex-grow border-t border-slate-200"
                                ></div>
                            </div>

                            <!-- Option 2: Address search -->
                            <form id="addressForm" class="flex gap-2">
                                <input
                                    type="text"
                                    id="addressInput"
                                    placeholder="Enter a city, an address..."
                                    class="flex-grow w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
                                />
                                <button
                                    type="submit"
                                    id="searchAddressBtn"
                                    class="flex-shrink-0 flex items-center justify-center gap-2 bg-slate-700 text-white font-bold p-3 rounded-lg hover:bg-slate-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500"
                                >
                                    <i
                                        data-feather="search"
                                        class="w-5 h-5"
                                    ></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Step 2: Radius -->
                    <div class="step opacity-40" id="step2">
                        <div class="flex items-center mb-3">
                            <span
                                class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-300 text-slate-600 font-bold text-lg mr-4"
                                id="step2-bubble"
                                >2</span
                            >
                            <h2 class="text-2xl font-bold text-slate-700">
                                Search radius
                            </h2>
                        </div>
                        <div class="ml-12">
                            <div
                                class="flex justify-between items-center text-slate-600 mb-2"
                            >
                                <label for="radius" class="font-medium"
                                    >Maximum distance:</label
                                >
                                <span
                                    id="radiusValue"
                                    class="font-bold text-lg text-indigo-600 bg-indigo-100 px-3 py-1 rounded-md"
                                    >850 km</span
                                >
                            </div>
                            <input
                                type="range"
                                id="radius"
                                min="10"
                                max="2000"
                                value="850"
                                step="10"
                                disabled
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                            />
                        </div>
                    </div>

                    <!-- Step 3: Go! -->
                    <div class="step opacity-40" id="step3">
                        <div class="flex items-center mb-3">
                            <span
                                class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-300 text-slate-600 font-bold text-lg mr-4"
                                id="step3-bubble"
                                >3</span
                            >
                            <h2 class="text-2xl font-bold text-slate-700">
                                Final destination
                            </h2>
                        </div>
                        <button
                            id="findPointBtn"
                            disabled
                            class="w-full flex items-center justify-center gap-3 bg-emerald-500 text-white font-bold py-4 px-4 rounded-lg shadow-lg hover:bg-emerald-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 disabled:bg-slate-300 disabled:shadow-none disabled:cursor-not-allowed transform hover:scale-105"
                        >
                            <i data-feather="send" class="w-6 h-6"></i>
                            <span class="text-xl">Find a destination!</span>
                        </button>
                    </div>
                </main>

                <footer class="text-center text-slate-400 text-sm mt-10">
                    <p>
                        Created with ❤️ for adventure. Maps by
                        <a
                            href="https://www.openstreetmap.org/copyright"
                            target="_blank"
                            class="underline hover:text-indigo-500"
                            >OpenStreetMap</a
                        >.
                    </p>
                </footer>
            </div>

            <!-- Map Panel (Right) -->
            <div id="map" class="h-96 md:h-full w-full"></div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // Render icons
                feather.replace();

                // References to HTML elements
                const locateBtn = document.getElementById("locateBtn");
                const addressForm = document.getElementById("addressForm");
                const addressInput = document.getElementById("addressInput");
                const searchAddressBtn =
                    document.getElementById("searchAddressBtn");
                const findPointBtn = document.getElementById("findPointBtn");
                const radiusSlider = document.getElementById("radius");
                const radiusValueSpan = document.getElementById("radiusValue");
                const step2 = document.getElementById("step2");
                const step3 = document.getElementById("step3");
                const step2Bubble = document.getElementById("step2-bubble");
                const step3Bubble = document.getElementById("step3-bubble");

                // Global variables
                let map;
                let userMarker, searchCircle, randomMarker;
                let userLocation = null;

                // --- MAP INITIALIZATION ---
                map = L.map("map").setView([46.6, 1.88], 5); // Wide view of France
                L.tileLayer(
                    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    {
                        attribution:
                            '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    },
                ).addTo(map);

                // --- EVENT HANDLERS ---
                locateBtn.addEventListener("click", locateUser);
                addressForm.addEventListener("submit", searchAddress);
                map.on("click", handleMapClick);
                radiusSlider.addEventListener("input", updateRadiusUI);
                findPointBtn.addEventListener("click", findRandomPoint);

                // --- MAIN FUNCTIONS ---

                function setUserLocation(lat, lng, zoomLevel = 13) {
                    userLocation = { lat, lng };

                    if (userMarker) {
                        userMarker.setLatLng([lat, lng]);
                    } else {
                        const userIcon = L.divIcon({
                            html: `<div class="h-6 w-6 bg-blue-500 rounded-full border-4 border-white shadow-lg"></div>`,
                            className: "",
                            iconSize: [24, 24],
                            iconAnchor: [12, 12],
                        });
                        userMarker = L.marker([lat, lng], { icon: userIcon })
                            .addTo(map)
                            .bindPopup("<b>Your starting point</b>");
                    }

                    map.setView([lat, lng], zoomLevel);
                    drawSearchCircle();
                    activateControls();
                    userMarker.openPopup();
                }

                function locateUser() {
                    if (!navigator.geolocation) {
                        alert("Geolocation is not supported by your browser.");
                        return;
                    }

                    setLocateBtnLoadingState(true);
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            setUserLocation(
                                position.coords.latitude,
                                position.coords.longitude,
                            );
                            setLocateBtnLoadingState(false);
                        },
                        (error) => {
                            alert(
                                "Unable to retrieve your position. Have you authorized access? Try searching for your address or clicking on the map.",
                            );
                            console.error(error);
                            setLocateBtnLoadingState(false);
                        },
                    );
                }

                async function searchAddress(event) {
                    event.preventDefault();
                    const query = addressInput.value;
                    if (!query) {
                        alert("Please enter an address.");
                        return;
                    }
                    setSearchBtnLoadingState(true);
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`,
                        );
                        if (!response.ok)
                            throw new Error("Network error during search.");

                        const data = await response.json();
                        if (data && data.length > 0) {
                            const { lat, lon } = data[0];
                            setUserLocation(parseFloat(lat), parseFloat(lon));
                        } else {
                            alert(
                                "Address not found. Try to be more specific.",
                            );
                        }
                    } catch (error) {
                        console.error("Geocoding error:", error);
                        alert(
                            "An error occurred while searching for the address.",
                        );
                    } finally {
                        setSearchBtnLoadingState(false);
                    }
                }

                function handleMapClick(e) {
                    if (
                        userLocation &&
                        !confirm("Set this point as the new starting position?")
                    ) {
                        return;
                    }
                    setUserLocation(e.latlng.lat, e.latlng.lng, map.getZoom());
                }

                function findRandomPoint() {
                    if (!userLocation) return;
                    if (randomMarker) map.removeLayer(randomMarker);

                    const radiusMeters = radiusSlider.value * 1000;
                    const r_earth = 6378137;
                    const y0 = userLocation.lat;
                    const x0 = userLocation.lng;

                    const u = Math.random();
                    const v = Math.random();

                    const w = (radiusMeters / r_earth) * Math.sqrt(u);
                    const t = 2 * Math.PI * v;
                    const x = w * Math.cos(t);
                    const y = w * Math.sin(t);

                    const new_x = x / Math.cos((y0 * Math.PI) / 180);

                    const foundLat = y0 + (y * 180) / Math.PI;
                    const foundLng = x0 + (new_x * 180) / Math.PI;

                    const destIcon = L.divIcon({
                        html: `<div class="flex flex-col items-center -mt-2 -ml-2"><i data-feather="flag" class="w-8 h-8 text-red-500"></i><span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full -mt-2 shadow">GO!</span></div>`,
                        className: "",
                        iconSize: [32, 32],
                    });

                    randomMarker = L.marker([foundLat, foundLng], {
                        icon: destIcon,
                    })
                        .addTo(map)
                        .bindPopup("<h2>ON VA LÀ !</h2><p>Bonne aventure !</p>")
                        .openPopup();
                    feather.replace();

                    const group = new L.featureGroup([
                        userMarker,
                        randomMarker,
                    ]);
                    map.fitBounds(group.getBounds().pad(0.3));
                }

                // --- UI FUNCTIONS ---

                function setLocateBtnLoadingState(isLoading) {
                    if (isLoading) {
                        locateBtn.disabled = true;
                        locateBtn.innerHTML = `<i data-feather="loader" class="w-5 h-5 animate-spin-slow"></i> <span>Locating...</span>`;
                    } else {
                        locateBtn.disabled = false;
                        locateBtn.innerHTML = `<i data-feather="map-pin" class="w-5 h-5"></i> <span>Locate me</span>`;
                    }
                    feather.replace();
                }

                function setSearchBtnLoadingState(isLoading) {
                    searchAddressBtn.disabled = isLoading;
                    if (isLoading) {
                        searchAddressBtn.innerHTML = `<i data-feather="loader" class="w-5 h-5 animate-spin-slow"></i>`;
                    } else {
                        searchAddressBtn.innerHTML = `<i data-feather="search" class="w-5 h-5"></i>`;
                    }
                    feather.replace();
                }

                function activateControls() {
                    step2.classList.remove("opacity-40");
                    step2Bubble.classList.remove(
                        "bg-slate-300",
                        "text-slate-600",
                    );
                    step2Bubble.classList.add("bg-indigo-600", "text-white");
                    radiusSlider.disabled = false;

                    step3.classList.remove("opacity-40");
                    step3Bubble.classList.remove(
                        "bg-slate-300",
                        "text-slate-600",
                    );
                    step3Bubble.classList.add("bg-indigo-600", "text-white");
                    findPointBtn.disabled = false;
                }

                function updateRadiusUI() {
                    radiusValueSpan.textContent = `${radiusSlider.value} km`;
                    if (userLocation) {
                        drawSearchCircle();
                    }
                }

                function drawSearchCircle() {
                    if (searchCircle) map.removeLayer(searchCircle);

                    const radiusMeters = radiusSlider.value * 1000;
                    searchCircle = L.circle(
                        [userLocation.lat, userLocation.lng],
                        {
                            radius: radiusMeters,
                            color: "#4f46e5",
                            weight: 3,
                            fillColor: "#4f46e5",
                            fillOpacity: 0.1,
                        },
                    ).addTo(map);

                    if (map.getZoom() > 2) {
                        map.fitBounds(searchCircle.getBounds());
                    }
                }
            });
        </script>
    </body>
</html>
